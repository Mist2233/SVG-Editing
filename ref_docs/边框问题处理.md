è¿™çœŸæ˜¯ä¸€ä¸ªâ€œæ¼«æ¼«é•¿å¾â€èˆ¬çš„ debug è¿‡ç¨‹ï¼Œä½†æˆ‘ä»¬ç¦»çœŸç†åªå·®æœ€åä¸€æ¯«ç±³äº†ï¼

ä½ æåˆ°çš„ **â€œæ— è¾¹æ¡†å›¾ç‰‡èƒ½ç”Ÿæˆå®Œç¾ç»“æœâ€** æ˜¯æœ€é‡è¦çš„çº¿ç´¢ã€‚è¿™ç›´æ¥è¯æ˜äº†ï¼š**Fillï¼ˆå¡«å……ï¼‰é€»è¾‘æ˜¯å¯¹çš„ï¼Œå‡ ä½•ï¼ˆGeometryï¼‰æ˜¯å¯¹çš„ï¼Œå”¯ä¸€çš„â€œå†…é¬¼â€å°±æ˜¯ Strokeï¼ˆæè¾¹ï¼‰ã€‚**

çœ‹é‚£å¼ ç´«è‰²çš„å›¾ï¼ˆå›¾ä¸€ï¼‰ï¼Œæ•´ä¸ªç”»é¢è¢«è’™ä¸Šäº†ä¸€å±‚ç´«è‰²ã€‚è¿™è¯´æ˜ï¼š**ç´«è‰²çš„æè¾¹ï¼ˆStrokeï¼‰å˜å¾—å¤ªå®½äº†ï¼Œæˆ–è€…é€æ˜åº¦æœ‰é—®é¢˜ï¼Œå¯¼è‡´å®ƒâ€œéª‘â€åœ¨å¡«å……ï¼ˆFillï¼‰ä¸Šé¢ï¼ŒæŠŠåº•ä¸‹çš„é¢œè‰²ç›–ä½äº†ã€‚**

`pydiffvg` çš„æ¸²æŸ“é¡ºåºæ˜¯ï¼šå…ˆç”» Fillï¼Œå†ç”» Strokeã€‚å¦‚æœ Stroke å¾ˆå®½ä¸”åŠé€æ˜ï¼Œå®ƒå°±ä¼šåƒä¸€å—æ»¤é•œä¸€æ ·ç›–ä½æ•´ä¸ªç‰©ä½“ã€‚

---

### ğŸ’Š æœ€ç»ˆä¿®æ­£æ–¹æ¡ˆï¼šå®ä½“å¡«å…… + é™åˆ¶æè¾¹ (Solid Fill & Constrained Stroke)

æˆ‘ä»¬éœ€è¦åˆ¶å®šä¸€å¥—**â€œç­‰çº§æ£®ä¸¥â€**çš„è§„åˆ™ï¼š
1.  **Fill (å¡«å……)** æ˜¯ä¸»è§’ï¼šå¿…é¡»æ˜¯ **100% ä¸é€æ˜ (Solid)**ï¼Œåªå…è®¸æ”¹é¢œè‰²ã€‚
2.  **Stroke (æè¾¹)** æ˜¯é…è§’ï¼šå…è®¸æ”¹é¢œè‰²å’Œé€æ˜åº¦ï¼Œä½†**ä¸¥ç¦å˜å¾—å¤ªç²—**ã€‚

è¯·ä¿®æ”¹ `batch_color_refine_v3.py` çš„ä»¥ä¸‹éƒ¨åˆ†ã€‚

#### 1. ä¿®æ”¹åˆå§‹åŒ– (Init)ï¼šæ¶ˆç­ç´«è‰²ï¼Œé‡ç½®ç²—ç»†

åœ¨ **Step 4 (Load SVG)** ä¹‹åï¼Œ**Step 5 (Optimizer)** ä¹‹å‰ï¼š

```python
    # ... (Step 4 ç»“æŸ) ...

    print("  [Init] Enforcing rules on Stroke and Fill...")
    for path in shapes:
        # [è§„åˆ™ A] å¼ºåˆ¶æŠŠæè¾¹å˜ç»†ï¼
        # æ—¢ç„¶åŸå›¾å¯èƒ½æœ‰å¾ˆç²—çš„æè¾¹å¯¼è‡´é®æŒ¡ï¼Œæˆ‘ä»¬å…ˆæŠŠå®ƒè®¾ä¸º 1.0
        # è¿™æ˜¯ä¸€ä¸ªå®‰å…¨çš„èµ·å§‹å€¼ï¼Œæ—¢èƒ½çœ‹åˆ°è¾¹æ¡†ï¼Œåˆä¸ä¼šæŒ¡ä½å†…éƒ¨
        if isinstance(path.stroke_width, torch.Tensor):
            path.stroke_width.data.fill_(1.5)
        else:
            path.stroke_width = torch.tensor(1.5).to(device)

    for group in shape_groups:
        # [è§„åˆ™ B] éšæœºåŒ–é¢œè‰² (å½»åº•æ€æ‰ç´«è‰²)
        if group.fill_color is not None:
            group.fill_color.data[:3] = torch.rand(3).to(device)
        if group.stroke_color is not None:
            group.stroke_color.data[:3] = torch.rand(3).to(device)
```

#### 2. ä¿®æ”¹ä¼˜åŒ–å™¨ (Optimizer)ï¼šFill å®å¿ƒï¼ŒStroke è‡ªç”±

åœ¨ **Step 5 (Optimizer)**ï¼š

```python
    color_optim_vars = []
    
    for group in shape_groups:
        # --- Fill Color (ä¸»è§’) ---
        if group.fill_color is not None:
            current_rgb = group.fill_color.data[:3].clone()
            
            # [å…³é”®] å¼ºåˆ¶ Fill ä¸º 100% ä¸é€æ˜ï¼
            # è¿™æ ·é¢œè‰²ä¼šéå¸¸é²œè‰³ï¼Œä¸ä¼šæ³›ç™½ï¼Œä¹Ÿä¸ä¼šé€å‡ºèƒŒæ™¯
            group.fixed_alpha = torch.tensor(1.0).to(device) 
            
            rgb_var = current_rgb.clone().detach().requires_grad_(True)
            group.custom_rgb_var = rgb_var 
            color_optim_vars.append(rgb_var)
            
        # --- Stroke Color (é…è§’) ---
        if group.stroke_color is not None:
            current_rgb = group.stroke_color.data[:3].clone()
            current_alpha = group.stroke_color.data[3].clone()
            
            # [å…³é”®] Stroke å…è®¸è°ƒèŠ‚é€æ˜åº¦
            # è¿™æ ·å¦‚æœä¼˜åŒ–å™¨è§‰å¾—ä¸éœ€è¦æè¾¹ï¼Œå¯ä»¥æŠŠ alpha é™ä¸º 0
            rgb_var = current_rgb.clone().detach().requires_grad_(True)
            alpha_var = current_alpha.clone().detach().requires_grad_(True)
            
            group.custom_stroke_rgb_var = rgb_var
            group.custom_stroke_alpha_var = alpha_var
            
            color_optim_vars.append(rgb_var)
            color_optim_vars.append(alpha_var)

    optimizer = torch.optim.Adam(color_optim_vars, lr=0.05)
```

#### 3. ä¿®æ”¹å¾ªç¯ (Loop)ï¼šé™åˆ¶æè¾¹ä¸Šé™

åœ¨ **Step 6 (Loop)**ï¼Œ`optimizer.step()` ä¹‹åï¼š

```python
        optimizer.step()
        
        # ... (ç°æœ‰çš„é¢œè‰²æ‹¼åˆä»£ç ä¸å˜) ...
        # æ³¨æ„ï¼šæ‹¼åˆæ—¶ fill ç”¨ fixed_alpha, stroke ç”¨ custom_stroke_alpha_var

        # ==========================================
        # [å…³é”®] ä¸¥é˜²æ­»å®ˆï¼šé™åˆ¶æè¾¹å®½åº¦ä¸Šé™
        # ==========================================
        for path in shapes:
            # ç»å¯¹ä¸å…è®¸è¶…è¿‡ 3.0 åƒç´ 
            # è¿™æ ·å®ƒå°±æ°¸è¿œæ— æ³•å˜æˆâ€œè’™ç‰ˆâ€ç›–ä½ Fill äº†
            path.stroke_width.data.clamp_(0.5, 3.0) 
        # ==========================================
```

---

### ğŸ”® ä¸ºä»€ä¹ˆè¿™æ¬¡èƒ½è¡Œï¼Ÿ

1.  **Fill Alpha = 1.0**ï¼šä¿è¯äº†æ‰‹å’Œç¬”æ†çš„é¢œè‰²æ˜¯æ‰å®çš„ï¼Œä¸ä¼šæ³›ç™½ï¼ˆè§£å†³äº†ä¹‹å‰çš„é—®é¢˜ï¼‰ã€‚
2.  **Random Init**ï¼šä¿è¯äº†èµ·å§‹ä¸æ˜¯ç´«è‰²ï¼Œä¼˜åŒ–å™¨ä¸ä¼šå› ä¸ºæ‡’æƒ°è€Œä¿ç•™ç´«è‰²ã€‚
3.  **Clamp Stroke Width < 3.0**ï¼šè¿™æ˜¯**ç»æ€**ã€‚æ— è®ºä¼˜åŒ–å™¨æ€ä¹ˆæƒ³å·æ‡’ï¼Œå®ƒéƒ½æ— æ³•æŠŠæè¾¹åŠ ç²—åˆ°è¦†ç›–æ•´ä¸ªç‰©ä½“çš„ç¨‹åº¦ã€‚å®ƒ**è¢«è¿«**åªèƒ½å»ä¿®æ”¹å†…éƒ¨ Fill çš„é¢œè‰²æ¥æ‹Ÿåˆç›®æ ‡ã€‚

**å¿«ç”¨è¿™ä¸ªé…ç½®è·‘ä¸€æ¬¡ï¼æˆ‘ç›¸ä¿¡è¿™å°±æ˜¯ Task 2 çš„æœ€ç»ˆå®Œç¾å½¢æ€äº†ã€‚**