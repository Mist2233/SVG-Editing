è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„å®éªŒæ¡ˆä¾‹ï¼ğŸ  é±¼å˜´å‰ªæï¼ˆRemovalï¼‰ä»»åŠ¡å®Œç¾åœ°æš´éœ²äº† **Pruning (å‰ªæ) ç­–ç•¥** ä¸­çš„éš¾ç‚¹ï¼š**â€œå¦‚ä½•åªå‰ªåäººï¼Œä¸ä¼¤å¥½äººï¼Ÿâ€**

### ğŸ” ç°è±¡åˆ†æ

1.  **å›¾ä¸‰ (è¿‡æ€):** é±¼å˜´å»æ‰äº†ï¼ˆå¥½äº‹ï¼‰ï¼Œä½†çœ¼ç›ä¹Ÿæ²¡äº†ï¼ˆåäº‹ï¼‰ã€‚
    *   *åŸå› ï¼š* ä½ çš„ Pruning é˜ˆå€¼å¤ªæ¿€è¿›ï¼Œæˆ–è€…åˆ¤åˆ«æ¡ä»¶å¤ªå®½æ³›ã€‚å¯èƒ½çœ¼ç›å’Œå˜´å·´çš„æŸäº›ç‰¹å¾ï¼ˆæ¯”å¦‚é¢ç§¯å°ã€Loss é«˜ï¼‰å¤ªç›¸ä¼¼ï¼Œå¯¼è‡´è¢«ä¸€èµ·å¹²æ‰äº†ã€‚
2.  **å›¾å›› (æ•´ä½“å˜æ·¡):** è¯•å›¾æŠŠå˜´å·´å˜æ·¡æ¥â€œè½¯åˆ é™¤â€ï¼Œç»“æœæ‰€æœ‰é»‘è‰²çº¿æ¡éƒ½å˜æ·¡äº†ã€‚
    *   *åŸå› ï¼š* è¿™è¯´æ˜ä¼˜åŒ–å™¨åœ¨å·æ‡’ã€‚
    *   åŸå›¾ä¸­é»‘è‰²çº¿æ¡å¾ˆå¤šï¼ˆçœ¼ç›ã€èº«ä½“è½®å»“ã€å˜´å·´ï¼‰ã€‚
    *   å¦‚æœç›®æ ‡å›¾ä¸­**å˜´å·´æ²¡äº†**ï¼Œå˜´å·´åŒºåŸŸçš„è¯¯å·®ä¼šå¾ˆå¤§ã€‚
    *   ä¼˜åŒ–å™¨å‘ç°ï¼šâ€œåªè¦æˆ‘æŠŠæ‰€æœ‰é»‘è‰²çº¿æ¡éƒ½å˜æˆåŠé€æ˜çš„æ£•è‰²ï¼Œå˜´å·´é‚£é‡Œçš„è¯¯å·®å°±å‡å°äº†ï¼â€ï¼ˆè™½ç„¶å…¶ä»–åœ°æ–¹è¯¯å·®å˜å¤§äº†ï¼Œä½†åœ¨ MSE å¹³å‡ä¸‹æ¥å¯èƒ½æ›´èµšï¼‰ã€‚
    *   è¿™æ˜¯ä¸€ç§ **Global Suboptimal Solution (å…¨å±€æ¬¡ä¼˜è§£)**ã€‚

---

### ğŸ’¡ æ ¸å¿ƒçŸ›ç›¾ï¼šå±€éƒ¨ vs å…¨å±€

*   **Removal ä»»åŠ¡çš„æœ¬è´¨ï¼š** æ˜¯ä¸€ä¸ª**å±€éƒ¨ (Local)** æ“ä½œã€‚åªæ”¹å˜´å·´ï¼Œåˆ«çš„åœ°æ–¹åˆ«åŠ¨ã€‚
*   **MSE Loss çš„æœ¬è´¨ï¼š** æ˜¯ä¸€ä¸ª**å…¨å±€ (Global)** ç»Ÿè®¡é‡ã€‚å®ƒä¸å…³å¿ƒä½ åœ¨å“ªæ”¹ï¼Œåªå…³å¿ƒå¹³å‡åˆ†ã€‚

**æˆ‘ä»¬è¦åšçš„ï¼Œæ˜¯å‘Šè¯‰ä¼˜åŒ–å™¨ï¼šâ€œè¯·æŠŠæ³¨æ„åŠ›é›†ä¸­åœ¨å˜´å·´é‚£ä¸ªåŒºåŸŸï¼Œåˆ«åŠ¨å…¶ä»–åœ°æ–¹ï¼â€**

---

### ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆ Aï¼šå¼•å…¥ Mask (æœ€ç¨³å¦¥)

å¦‚æœä½ èƒ½çŸ¥é“â€œå˜´å·´å¤§æ¦‚åœ¨å“ªâ€ï¼ˆæ¯”å¦‚ä¹‹å‰çš„ Image Editing è¿‡ç¨‹äº§ç”Ÿäº†ä¸€ä¸ª Difference Maskï¼‰ï¼Œé‚£äº‹æƒ…å°±ç®€å•äº†ã€‚
ä½†å¦‚æœä¸èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ **High-Frequency Loss Map** æ¥è‡ªåŠ¨å®šä½ã€‚

**æ“ä½œæ­¥éª¤ï¼š**
1.  è®¡ç®—å½“å‰ SVG æ¸²æŸ“å›¾ä¸ Target çš„å·®å€¼å›¾ï¼š`diff = abs(img - target)`ã€‚
2.  å¯¹ `diff` å›¾è¿›è¡Œé«˜æ–¯æ¨¡ç³Šï¼Œæ‰¾åˆ°**é«˜è¯¯å·®åŒºåŸŸ (ROI)**ã€‚
3.  **åªå¯¹ ROI åŒºåŸŸå†…çš„ Path è¿›è¡Œ Pruningï¼**
    *   æ£€æŸ¥æ¯ä¸ª Path çš„ä¸­å¿ƒç‚¹æ˜¯å¦è½åœ¨é«˜è¯¯å·®åŒºåŸŸå†…ã€‚
    *   å¦‚æœåœ¨åŒºåŸŸå†…ï¼Œä¸”è¯¥ Path çš„é¢œè‰²ä¸ Target èƒŒæ™¯è‰²å·®å¼‚å¤§ -> **åˆ æ‰ï¼**
    *   å¦‚æœåœ¨åŒºåŸŸå¤– -> **ä¿æŠ¤èµ·æ¥ï¼Œä¸è®¸åŠ¨ï¼** (Set `requires_grad=False`)

### ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆ Bï¼šç»†åŒ– Pruning é€»è¾‘ (æ›´æ™ºèƒ½çš„åˆ¤æ®)

æ—¢ç„¶å›¾ä¸‰é‡Œçœ¼ç›è¢«è¯¯åˆ äº†ï¼Œè¯´æ˜â€œçœ¼ç›â€å’Œâ€œå˜´å·´â€åœ¨ä½ çš„å‰ªææ ‡å‡†ä¸‹çœ‹èµ·æ¥ä¸€æ ·ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å®ƒä»¬çš„åŒºåˆ«ã€‚

*   **å˜´å·´ï¼š** åœ¨ Target å›¾ç‰‡é‡Œï¼Œå˜´å·´é‚£ä¸ªä½ç½®å¯¹åº”çš„é¢œè‰²æ˜¯**èº«ä½“çš„é»„è‰²**ï¼ˆå› ä¸ºå˜´å·´æ²¡äº†ï¼Œéœ²å‡ºäº†èº«ä½“ï¼‰ã€‚
*   **çœ¼ç›ï¼š** åœ¨ Target å›¾ç‰‡é‡Œï¼Œçœ¼ç›é‚£ä¸ªä½ç½®ä¾ç„¶æ˜¯**é»‘è‰²**ï¼ˆçœ¼ç›è¿˜åœ¨ï¼‰ã€‚

**æ”¹è¿›åçš„ Pruning é€»è¾‘ï¼š**

åœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­ï¼Œå®šæœŸï¼ˆæ¯”å¦‚æ¯ 50 è½®ï¼‰æ£€æŸ¥æ¯ä¸ª Pathï¼š
1.  **æ¸²æŸ“è¯¥ Pathï¼š** æ¯”å¦‚åªæ¸²æŸ“ç¬¬ $i$ ä¸ª Pathï¼Œå¾—åˆ°æ©ç  $M_i$ã€‚
2.  **é‡‡æ · Targetï¼š** ç”¨ $M_i$ å» Target å›¾ç‰‡ä¸Šé‡‡æ ·å¹³å‡é¢œè‰² $C_{target}$ã€‚
3.  **å¯¹æ¯”é¢œè‰²ï¼š** å¯¹æ¯” $C_{target}$ å’Œè¯¥ Path ç°åœ¨çš„é¢œè‰² $C_{path}$ã€‚
    *   **å¦‚æœé¢œè‰²å·®å¼‚å·¨å¤§**ï¼ˆæ¯”å¦‚å˜´å·´æ˜¯é»‘çš„ï¼Œä½† Target å¯¹åº”ä½ç½®æ˜¯é»„çš„ï¼‰ -> **è¯´æ˜è¿™ä¸ªç‰©ä½“åœ¨ Target é‡Œæ¶ˆå¤±äº† -> å‰ªæ‰ï¼(Prune)**
    *   **å¦‚æœé¢œè‰²å·®ä¸å¤š**ï¼ˆæ¯”å¦‚çœ¼ç›æ˜¯é»‘çš„ï¼ŒTarget å¯¹åº”ä½ç½®ä¹Ÿæ˜¯é»‘çš„ï¼‰ -> **ä¿ç•™ï¼**

**è¿™ä¸ªé€»è¾‘éå¸¸å¼ºå¤§ï¼Œå®ƒåˆ©ç”¨äº† Target å›¾ç‰‡çš„ä¿¡æ¯æ¥æŒ‡å¯¼å‰ªæã€‚**

---

### ğŸ’» ä»£ç æ€è·¯ (Color-Guided Pruning)

æˆ‘å»ºè®®ä½ å°è¯• **æ–¹æ¡ˆ B**ã€‚ä½ éœ€è¦å†™ä¸€ä¸ªå°å‡½æ•° `check_pruning`ã€‚

```python
def check_pruning(shapes, shape_groups, target_image, device):
    """
    åŸºäºé¢œè‰²çš„æ™ºèƒ½å‰ªæï¼šå¦‚æœ Path çš„é¢œè‰²å’Œ Target å¯¹åº”ä½ç½®çš„é¢œè‰²å®Œå…¨å¯¹ä¸ä¸Šï¼Œå°±åˆ æ‰ã€‚
    """
    
    # 1. æ¸²æŸ“å½“å‰æ‰€æœ‰å½¢çŠ¶ (å¾—åˆ°ä¸€å¼ å…¨å›¾)
    # ... (çœç•¥æ¸²æŸ“ä»£ç ) ...
    # å‡è®¾æˆ‘ä»¬å¾—åˆ°äº† rendered_img
    
    prune_indices = []
    
    for i, path in enumerate(shapes):
        # 2. è®¡ç®—è¯¥ Path çš„ä¸­å¿ƒç‚¹ (ç®€åŒ–ç‰ˆï¼Œæ¯”æ¸²æŸ“ mask å¿«)
        center = path.points.mean(dim=0).long()
        cx, cy = center[0].item(), center[1].item()
        
        # è¾¹ç•Œæ£€æŸ¥
        if not (0 <= cx < target_image.shape[1] and 0 <= cy < target_image.shape[0]):
            continue
            
        # 3. è·å– Target åœ¨è¯¥ä½ç½®çš„é¢œè‰²
        target_color = target_image[cy, cx, :3] # RGB
        
        # 4. è·å– Path å½“å‰çš„é¢œè‰²
        group = shape_groups[i] # å‡è®¾ä¸€ä¸€å¯¹åº”ï¼Œå®é™…è¦æŸ¥ shape_ids
        if group.fill_color is not None:
            path_color = group.fill_color[:3]
        elif group.stroke_color is not None:
            path_color = group.stroke_color[:3]
        else:
            continue
            
        # 5. è®¡ç®—è‰²å·® (æ¬§æ°è·ç¦»)
        color_diff = torch.norm(target_color - path_color)
        
        # 6. åˆ¤å†³ï¼šå¦‚æœè‰²å·®å¤§äºé˜ˆå€¼ (æ¯”å¦‚ 0.5)ï¼Œè¯´æ˜è¿™ä¸ªç‰©ä½“ä¸è¯¥å­˜åœ¨
        if color_diff > 0.4: 
            print(f"  [Prune] Path {i} color diff {color_diff:.2f} -> REMOVE!")
            prune_indices.append(i)
            
    # æ‰§è¡Œåˆ é™¤ (æ³¨æ„å€’åºåˆ ï¼Œæˆ–è€…æ ‡è®°åé‡å»ºåˆ—è¡¨)
    # ...
```

**è¯•ç€ç”¨è¿™ä¸ªé€»è¾‘å»æ”¹å†™ä½ çš„ `advanced_refine.py`ã€‚çœ¼ç›å’Œå˜´å·´çš„å‘½è¿ï¼Œå°±åœ¨äºå®ƒä»¬èƒ½ä¸èƒ½ç»å¾—èµ· Target å›¾ç‰‡çš„é¢œè‰²è€ƒéªŒï¼**